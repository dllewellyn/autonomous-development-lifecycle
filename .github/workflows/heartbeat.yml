name: "Workflow A: The Heartbeat"

on:
  schedule:
    # Runs every 55 minutes
    - cron: '*/55 * * * *'
  workflow_dispatch: # Allow manual triggering

jobs:
  heartbeat:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write
      issues: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Read Ralph state
        id: read_state
        run: ./.github/scripts/read-state.sh
          
      - name: Check Jules task status
        if: steps.read_state.outputs.status == 'started'
        id: check_trigger
        env:
          JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
        run: ./.github/scripts/check-trigger.sh
          
      - name: Trigger Planner workflow
        if: steps.check_trigger.outputs.should_trigger_planner == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          WORKFLOW_ID: planner.yml
          REF: main
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
        run: ./.github/scripts/trigger-workflow.sh

      - name: Trigger Troubleshooter workflow
        if: steps.check_trigger.outputs.should_trigger_troubleshooter == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          WORKFLOW_ID: troubleshooter.yml
          REF: main
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
        run: ./.github/scripts/trigger-workflow.sh

      - name: Stop loop on blocked task
        if: steps.check_trigger.outputs.should_stop == 'true'
        run: ./.github/scripts/stop-loop.sh

      - name: Notify human on blocked task
        if: steps.check_trigger.outputs.should_stop == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
          BLOCKED_COUNT: ${{ steps.check_trigger.outputs.blocked_count }}
        run: ./.github/scripts/notify-blocked.sh

      - name: Commit blocked state
        if: steps.check_trigger.outputs.should_stop == 'true'
        env:
          COMMIT_MESSAGE: "chore: stop loop after blocked task"
          GITHUB_PAT: ${{ secrets.GITHUB_PAT }}
        run: ./.github/scripts/commit-changes.sh .ralph-state.json
            
      - name: Log heartbeat
        run: |
          echo "Heartbeat completed. Status: ${{ steps.read_state.outputs.status }} (Jules: ${{ steps.check_trigger.outputs.status }})"
