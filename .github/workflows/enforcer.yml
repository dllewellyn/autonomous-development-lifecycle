name: "Workflow D: The Enforcer"

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  enforce:
    runs-on: ubuntu-latest
    permissions:
      contents: write          # Allow pushing commits
      pull-requests: write     # Allow creating reviews and comments
      issues: write            # Allow creating issue comments
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Need full history for diff
          
      - name: Prepare PR context
        env:
          BASE_REF: ${{ github.base_ref }}
        run: ./.github/scripts/prepare-pr-context.sh
          
      - name: Audit against Constitution with Gemini CLI
        id: audit
        uses: google-github-actions/run-gemini-cli@v0
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          prompt: |
            You are the Enforcer for an autonomous development system.
            
            Your task is to review the code changes in this pull request against the repository's CONSTITUTION.md and ensure the intended task has been completed correctly as per TASKS.md.
            
            Please:
            1. Read CONSTITUTION.md to understand the repository rules.
            2. Read TASKS.md to identify the task(s) this PR is intended to complete.
            3. Read pr_diff.txt to examine the changes.
            4. Verify that:
               - The changes comply with ALL rules in CONSTITUTION.md.
               - The intended task(s) from TASKS.md have been implemented correctly and completely.
            5. If there are code violations or the task implementation is incorrect/incomplete, list them as violations.
            6. If everything is compliant and the task is fully satisfied, respond with "COMPLIANT".
            
            Respond in JSON format:
            {
              "compliant": true/false,
              "violations": ["reason/violation 1", "reason/violation 2", ...]
            }
            
      - name: Parse audit result
        id: parse_result
        run: ./.github/scripts/parse-audit-result.sh "${{ steps.audit.outputs.summary }}"
          
      - name: Post violations
        if: steps.parse_result.outputs.compliant == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const auditResult = JSON.parse(fs.readFileSync('audit_result.json', 'utf8'));
            
            const violations = auditResult.violations.map(v => `- ${v}`).join('\n');
            const comment = `## ðŸš¨ Constitution Violation Detected\n\n@jules The following violations were found:\n\n${violations}\n\nPlease address these issues before merging.`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
            
            // Request changes
            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              event: 'REQUEST_CHANGES',
              body: 'Constitution violations detected. See comments for details.'
            });
            
      - name: Approve and merge
        if: steps.parse_result.outputs.compliant == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Approve the PR
            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              event: 'APPROVE',
              body: 'âœ… All constitution rules satisfied. Auto-approving.'
            });
            
            // Merge the PR
            try {
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number,
                merge_method: 'squash'
              });
              console.log('PR merged successfully');
            } catch (error) {
              console.log('Failed to merge PR:', error.message);
              // May fail due to branch protection rules or conflicts
            }
