name: "Workflow D: The Enforcer"

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  enforce:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Need full history for diff
          
      - name: Prepare PR context
        env:
          BASE_REF: ${{ github.base_ref }}
        run: ./.github/scripts/prepare-pr-context.sh
          
      - name: Audit against Constitution with Gemini CLI
        id: audit
        uses: google-github-actions/run-gemini-cli@v0
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          prompt: |
            You are the Enforcer for an autonomous development system.
            
            Review the following PR diff against the repository's CONSTITUTION.md.
            
            Your task:
            1. Check if the changes comply with ALL rules in CONSTITUTION.md
            2. If there are violations, list them clearly with specific line references
            3. If compliant, respond with "COMPLIANT"
            
            Respond in JSON format:
            {
              "compliant": true/false,
              "violations": ["violation 1", "violation 2", ...]
            }
            
            --- CONSTITUTION.md ---
            ${{ env.CONSTITUTION_CONTENT }}
            
            --- PR DIFF ---
            ${{ env.PR_DIFF_CONTENT }}
            
      - name: Parse audit result
        id: parse_result
        run: ./.github/scripts/parse-audit-result.sh "${{ steps.audit.outputs.summary }}"
          
      - name: Post violations
        if: steps.parse_result.outputs.compliant == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_TOKEN }}
          script: |
            const fs = require('fs');
            const auditResult = JSON.parse(fs.readFileSync('audit_result.json', 'utf8'));
            
            const violations = auditResult.violations.map(v => `- ${v}`).join('\n');
            const comment = `## ðŸš¨ Constitution Violation Detected\n\n@jules The following violations were found:\n\n${violations}\n\nPlease address these issues before merging.`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
            
            // Request changes
            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              event: 'REQUEST_CHANGES',
              body: 'Constitution violations detected. See comments for details.'
            });
            
      - name: Approve and merge
        if: steps.parse_result.outputs.compliant == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_TOKEN }}
          script: |
            // Approve the PR
            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              event: 'APPROVE',
              body: 'âœ… All constitution rules satisfied. Auto-approving.'
            });
            
            // Merge the PR
            try {
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number,
                merge_method: 'squash'
              });
              console.log('PR merged successfully');
            } catch (error) {
              console.log('Failed to merge PR:', error.message);
              // May fail due to branch protection rules or conflicts
            }
