name: "Workflow D: The Enforcer"

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  enforce:
    runs-on: ubuntu-latest
    permissions:
      contents: write          # Allow pushing commits
      pull-requests: write     # Allow creating reviews and comments
      issues: write            # Allow creating issue comments
      actions: read            # Allow listing workflow runs
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Need full history for diff

      - name: Wait for and check other workflows
        uses: actions/github-script@v7
        env:
          JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            
            // Get the head SHA of the PR
            const headSha = context.payload.pull_request.head.sha;
            console.log(`Checking for other workflows on commit: ${headSha}`);

            const sleep = (ms) => new Promise(r => setTimeout(r, ms));
            const TIMEOUT_MS = 15 * 60 * 1000; // 15 minutes timeout
            const POLL_INTERVAL_MS = 30000;    // 30 seconds
            const startTime = Date.now();

            let runs = [];
            let pendingRuns = [];
            const currentRunId = context.runId;

            while (Date.now() - startTime < TIMEOUT_MS) {
              // List workflow runs for the commit
              const { data: listData } = await github.rest.actions.listWorkflowRunsForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                head_sha: headSha
              });
              
              runs = listData.workflow_runs.filter(run => run.id !== currentRunId);
              
              pendingRuns = runs.filter(run => 
                ['queued', 'in_progress', 'waiting'].includes(run.status)
              );

              if (pendingRuns.length === 0) {
                console.log('All other workflows have completed.');
                break;
              }

              const pendingNames = pendingRuns.map(r => r.name).join(', ');
              console.log(`Waiting for ${pendingRuns.length} workflow(s) to complete: ${pendingNames}`);
              await sleep(POLL_INTERVAL_MS);
            }

            if (pendingRuns.length > 0) {
              core.setFailed(`Timeout waiting for workflows: ${pendingRuns.map(r => r.name).join(', ')}`);
              return;
            }

            // Check for failures among the completed runs
            const failedRuns = runs.filter(run => 
              ['failure', 'cancelled', 'timed_out'].includes(run.conclusion)
            );

            if (failedRuns.length > 0) {
              console.log(`Found ${failedRuns.length} failed workflow(s).`);
              
              const failureDetails = failedRuns.map(run => 
                `- **${run.name}**: [View Log](${run.html_url})`
              ).join('\n');

              const message = `## âŒ CI Checks Failed\n\nThe following workflows failed for this commit:\n\n${failureDetails}\n\nPlease fix the build/tests before merging.`;

              // Post comment to PR
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: message
              });

              // Send to Jules API
              try {
                if (fs.existsSync('.ralph-state.json')) {
                  const state = JSON.parse(fs.readFileSync('.ralph-state.json', 'utf8'));
                  const sessionId = state.current_task_id;
                  
                  if (sessionId) {
                    console.log(`Reporting failure to Jules Session: ${sessionId}`);
                    const julesKey = process.env.JULES_API_KEY;
                    
                    await fetch(`https://jules.googleapis.com/v1alpha/sessions/${sessionId}:sendMessage`, {
                      method: 'POST',
                      headers: {
                        'Content-Type': 'application/json',
                        'X-Goog-Api-Key': julesKey
                      },
                      body: JSON.stringify({
                        message: {
                          content: `CI Checks Failed:\n\n${failureDetails}\n\nPlease investigate the logs and fix the errors.`
                        }
                      })
                    });
                  }
                }
              } catch (error) {
                console.error('Error reporting to Jules:', error);
              }

              // Fail the Enforcer job
              core.setFailed('Other workflows have failed. Blocking merge.');
            } else {
              console.log('All other workflows passed.');
            }
          
      - name: Prepare PR context
        env:
          BASE_REF: ${{ github.base_ref }}
        run: ./.github/scripts/prepare-pr-context.sh

      - name: Audit against Constitution with Gemini CLI
        id: audit
        uses: google-github-actions/run-gemini-cli@v0
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          prompt: |
            You are the Enforcer for an autonomous development system.
            
            Your task is to review the code changes in this pull request against the repository's CONSTITUTION.md and ensure the intended task has been completed correctly as per TASKS.md.
            
            Please:
            1. Read "CONSTITUTION.md" to understand the repository rules.
            2. Read "TASKS.md" to identify the task(s) this PR is intended to complete.
            3. Read "pr_diff.txt" to examine the changes.
            4. Verify that:
               - The changes comply with ALL rules in CONSTITUTION.md.
               - The intended task(s) from TASKS.md have been implemented correctly and completely.
            5. If there are code violations or the task implementation is incorrect/incomplete, list them as violations.
            6. If everything is compliant and the task is fully satisfied, respond with "COMPLIANT".
            
            Respond in JSON format:
            {
              "compliant": true/false,
              "violations": ["reason/violation 1", "reason/violation 2", ...]
            }
            
      - name: Parse audit result
        id: parse_result
        env:
          AUDIT_RESPONSE: ${{ steps.audit.outputs.summary }}
        run: ./.github/scripts/parse-audit-result.sh
          
      - name: Post violations
        if: steps.parse_result.outputs.compliant == 'false'
        uses: actions/github-script@v7
        env:
          JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const auditResult = JSON.parse(fs.readFileSync('audit_result.json', 'utf8'));
            
            const violations = auditResult.violations.map(v => `- ${v}`).join('\n');
            const comment = `## ðŸš¨ Constitution Violation Detected\n\n@jules The following violations were found:\n\n${violations}\n\nPlease address these issues before merging.`;
            
            // 1. Post to PR
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
            
            // 2. Request changes
            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              event: 'REQUEST_CHANGES',
              body: 'Constitution violations detected. See comments for details.'
            });

            // 3. Send feedback directly to Jules API
            try {
              const state = JSON.parse(fs.readFileSync('.ralph-state.json', 'utf8'));
              const sessionId = state.current_task_id;
              
              if (sessionId) {
                console.log(`Sending violation feedback to Jules Session: ${sessionId}`);
                const julesKey = process.env.JULES_API_KEY;
                
                const response = await fetch(`https://jules.googleapis.com/v1alpha/sessions/${sessionId}:sendMessage`, {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    'X-Goog-Api-Key': julesKey
                  },
                  body: JSON.stringify({
                    message: {
                      content: `Constitution Violation Detected:\n\n${violations}\n\nPlease fix these issues immediately.`
                    }
                  })
                });
                
                if (!response.ok) {
                   console.error('Failed to send message to Jules:', await response.text());
                } else {
                   console.log('Successfully sent feedback to Jules API');
                }
              } else {
                console.log('No active Jules session ID found in .ralph-state.json. Skipping API feedback.');
              }
            } catch (error) {
              console.error('Error sending feedback to Jules:', error);
            }
            
      - name: Approve and merge
        if: steps.parse_result.outputs.compliant == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Check if PR is a draft and mark as ready if needed
            try {
              const { data: pr } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number
              });

              if (pr.draft) {
                console.log('PR is in draft status. Marking as ready for review...');
                await github.graphql(`
                  mutation($pullRequestId: ID!) {
                    markPullRequestReadyForReview(input: {pullRequestId: $pullRequestId}) {
                      pullRequest {
                        id
                        isDraft
                      }
                    }
                  }
                `, {
                  pullRequestId: pr.node_id
                });
                console.log('PR marked as ready for review.');
              }
            } catch (error) {
               console.log('Failed to check/update draft status:', error.message);
            }

            // Approve the PR
            try {
              await github.rest.pulls.createReview({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number,
                event: 'APPROVE',
                body: 'âœ… All constitution rules satisfied. Auto-approving.'
              });
            } catch (error) {
              console.log('Failed to approve PR (likely due to permissions):', error.message);
              // Continue to merge attempt
            }
            
            // Merge the PR
            try {
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number,
                merge_method: 'squash'
              });
              console.log('PR merged successfully');
            } catch (error) {
              console.log('Failed to merge PR:', error.message);
              // May fail due to branch protection rules or conflicts
            }
