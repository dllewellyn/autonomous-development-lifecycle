name: "Workflow E: The Strategist"

on:
  push:
    branches:
      - main

jobs:
  evolve:
    runs-on: ubuntu-latest
    permissions:
      contents: write          # Allow pushing commits
      actions: write           # Allow triggering workflows
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2 # Need previous commit for comparison
          
      - name: Prepare merge context
        run: ./.github/scripts/prepare-merge-context.sh
          
      - name: Extract lessons learned with Gemini CLI
        id: analyze
        uses: google-github-actions/run-gemini-cli@v0
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          prompt: |
            You are the Strategist for an autonomous development system.
            
            A PR has just been merged to main. Analyze the changes and extract lessons learned.
            
            Your task:
            1. Read "AGENTS.md" to understand current lessons.
            2. Read "merge_diff.txt" to see the merged changes.
            3. Review the merged changes for patterns, challenges, or insights.
            4. Update AGENTS.md with new lessons learned.
            5. Format as a new entry with today's date.
            
            IMPORTANT:
            - If no new lessons are found, output the original content of "AGENTS.md" exactly as is.
            - Output ONLY the raw content of the updated file.
            - Do NOT use markdown code blocks (```).
            - Do NOT include any conversational text (e.g., "Here is the updated file").
            - The output must start directly with the file content.
            
      - name: Save updated AGENTS.md
        env:
          AGENTS_SUMMARY: ${{ steps.analyze.outputs.summary }}
        run: ./.github/scripts/save-agents-memory.sh
          
      - name: Update TASKS.md with Gemini CLI
        id: update_tasks
        uses: google-github-actions/run-gemini-cli@v0
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          prompt: |
            You are the Strategist for an autonomous development system.
            
            A task has been completed and merged. Update TASKS.md by:
            1. Reading "TASKS.md" to see the current backlog.
            2. Reading "merge_diff.txt" to identify the completed task.
            3. Marking the completed task as complete.
            4. Working out if any new tasks need to be added based on the goals and the completed work.
            5. Re-ordering the tasks list based on priority.
            6. Return the updated TASKS.md content.
            
            IMPORTANT:
            - Output ONLY the raw content of the updated file.
            - Do NOT use markdown code blocks (```).
            - Do NOT include any conversational text.
            - The output must start directly with the file content.
            
      - name: Save updated TASKS.md
        env:
          TASKS_SUMMARY: ${{ steps.update_tasks.outputs.summary }}
        run: ./.github/scripts/save-tasks.sh
          
      - name: Restart loop
        run: ./.github/scripts/restart-loop.sh
          
      - name: Commit changes
        env:
          COMMIT_MESSAGE: "chore: update agent memory and restart loop"
          GITHUB_PAT: ${{ secrets.GITHUB_PAT }}
        run: ./.github/scripts/commit-changes.sh AGENTS.md TASKS.md .ralph-state.json

      - name: Trigger Planner
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          WORKFLOW_ID: planner.yml
          REF: main
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
        run: ./.github/scripts/trigger-workflow.sh
