name: "Workflow B: The Planner"

on:
  workflow_dispatch: # Triggered by Heartbeat workflow

jobs:
  plan:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: write          # Allow pushing commits
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Generate plan with Gemini CLI
        id: analyze
        timeout-minutes: 15
        uses: google-github-actions/run-gemini-cli@v0
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          prompt: |
            You are the Planner for an autonomous development system.
            
            Analyze the following files by reading them directly:
            - "GOALS.md": Long-term vision
            - "TASKS.md": Current backlog
            - "CONTEXT_MAP.md": Architectural map
            - "AGENTS.md": Learned behaviors and performance
            
            Generate a detailed technical plan for the next task to work on.
            The plan should:
            1. Select the highest priority task from TASKS.md
            2. Break it down into concrete implementation steps
            3. Reference relevant parts of CONTEXT_MAP.md
            4. Consider lessons learned from AGENTS.md
            5. Be specific enough for Jules to execute
            
      - name: Check for active session
        env:
          JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
        run: ./.github/scripts/check-active-session.sh

      - name: Create Jules task with generated plan
        id: jules_task
        env:
          JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
          PROMPT: ${{ steps.analyze.outputs.summary }}
        run: |
          SESSION_ID=$(./.github/scripts/start-jules-session.sh "$PROMPT")
          echo "session_id=$SESSION_ID" >> "$GITHUB_OUTPUT"
          
      - name: Update Ralph state
        env:
          NEW_SESSION_ID: ${{ steps.jules_task.outputs.session_id }}
        run: ./.github/scripts/update-state.sh "$NEW_SESSION_ID"
          
      - name: Commit changes
        env:
          COMMIT_MESSAGE: "chore: updated state after creating Jules task"
        run: ./.github/scripts/commit-changes.sh .ralph-state.json